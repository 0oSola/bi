// JavaScript Document

(function(){
	
	$(function(){
		$("[data-toggle='tooltip']").tooltip();	
		$("html").on("click",function(){
			if($("#msg-box").css("top")=='0px'){
				$("#msg-box").animate({top:"-50%"});
			}
		});
		$("#msg-box").on("click",function(){
			$(this).animate({top:"-50%"});
		});
		
		//加载扩展模块
		layer.config({
			extend: 'extend/layer.ext.js'
		});
		
		$(".close-report").on("click",function(){
			if (confirm("您确定要关闭此报表吗？")) {
				window.opener = null;
				window.open('', '_self');
				window.close();
			} else {}
		});
		
		//按钮控制
		var clickone = 0;
		
		$(".db-list").off("click");
		$(".db-list").on("click",function(){
			var target = $(this).find(".db-list-icon");
			if($("#db-box").css("display")=="none"){
				if(target.hasClass("fa-plus-square")){
					target.removeClass("fa-plus-square");
					target.addClass("fa-minus-square");
				}
			}else{
				if(target.hasClass("fa-minus-square")){
					target.removeClass("fa-minus-square");
					target.addClass("fa-plus-square");
				}
			}
			if(clickone==1){
				target.removeClass("fa-minus-square");
				target.addClass("fa-plus-square");
			}
			clickone = clickone+1;
		})
		$("#menu").find("li").on("click",function(){
			event.stopPropagation();
		});
		
	
	})
	
	$('.drag').draggable({ 
	  appendTo: 'body',
	  helper: 'clone'
	});
	
	$('#reportZone').droppable({
	  activeClass: 'active',
	  hoverClass: 'hover',
	  disabled:false,
	  accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
	  drop: function (e, ui) {
			var $ele = $($(".chart-tpl").html()),
				dragui = ui.draggable;
				
			$ele.find(".img-box").attr("src",dragui.find(".sc-img").attr("src"));
			$ele.find(".chart-name").html(dragui.find(".img-Name").html());
			$ele.find(".remove").on("click",function(){
				$("#deleteEleModal").modal("show");
				$(".deleteEleBtn").off("click");
				$(".deleteEleBtn").on("click",function(){
					$ele.remove();
					$("#deleteEleModal").modal("hide");
					if($('#reportZone').html()==''){
						$("#reportZone").css("height","100%");
					}
				});
				
			})
			$ele.find(".chart-name").off("dblclick");
			$ele.find(".chart-name").on("dblclick",function(){
				$(this).focus();
			});
			$ele.find(".bz-box").off("dblclick");
			$ele.find(".bz-box").on("dblclick",function(){
				$(this).focus();
			});
			$(this).append($ele);
			$("[data-toggle='tooltip']").tooltip();
			$("#reportZone").css("height","auto");
	  }
	}).sortable({
		  items: '.drop-item',
		  sort: function() {
				// gets added unintentionally by droppable interacting with sortable
				// using connectWithSortable fixes this, but doesn't allow you to customize active/hoverClass options
				$( this ).removeClass( "active" );
		  }
	});
	
	//生成报表
	$(".save-report").on("click",function(){
		$("#report-tpl").html("");
		
		//test
		/*layer.open({
			title:'报表地址',
			content: "url",
			scrollbar: false,
			area: '430px',
			btn: ['提交任务', '关闭', '复制去分享','去访问'],
			yes: function(index, layero){
				loadUnNeed("url");
				var buttonName = "提交任务";
				addition = "报表生成完成";
				logupLoad(buttonName,addition);
			},cancel: function(index){
				var buttonName = "关闭";
				addition = "报表生成完成";
				logupLoad(buttonName,addition);
			},
			btn3: function(index,layero){
				var buttonName = "复制去分享";
				addition = "报表生成完成";
				logupLoad(buttonName,addition);
			},btn4: function(index,layero){
				var buttonName = "去访问";
				addition = "报表生成完成";
				logupLoad(buttonName,addition);
			}
		});
		
		$(".layui-layer-btn2").zclip({ 
			path: '../static/js/jquery-zclip/ZeroClipboard.swf', 
			copy: function(){//复制内容 
				return "url"; 
			}, 
			afterCopy: function(){//复制成功 
				$('.success-heading').html("复制成功！！");
				$('#success-box').animate({top:'0'});
				setTimeout("$('#success-box').animate({top:'-50%'})",3000);
			}
		});*/
		
		//end test

		var html_tpl ='<body><div id="main" style="height:100%;">'+$("#main").html()+"</div></body>";
		$("#report-tpl").html("<html>"+html_tpl+"</html>");
		var report = $("#report-tpl");
		
		report.find("#menu").remove();
		report.find("script").remove();
		report.find("title").html($("#reoprt-name").html());
		report.find("#main").css("padding-left","0");
		report.find(".menu-button").remove();
		report.find(".ui-helper-hidden-accessible").remove();	
		report.find(".ui-tooltip").remove();
		report.find(".edit-box").removeAttr("contenteditable");	
		report.find(".edit-box").removeAttr("data-toggle");
		report.find(".edit-box").removeAttr("data-placement");
		report.find(".edit-box").removeAttr("title");
		report.find(".edit-box").removeClass("edit-box");	
		report.find(".remove").remove();
		report.find("#success-box").remove();
		report.find("#msg-box").remove();
		report.find("#spin").remove();
		report.find(".close-report").remove();
		report.find(".save-report").remove();
		
		var title = $("#reoprt-name").html();
		var html_layout = "<html><head><meta charset='UTF-8'><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'> <meta name='viewport' content='width=device-width, initial-scale=1.0'><title>"+title+"</title><link rel='stylesheet' type='text/css' href='{{ url_for('static', filename='css/bootstrap/bootstrap.min.css') }}'><link rel='stylesheet' type='text/css' href='{{ url_for('static', filename='css/reset.css') }}'><link rel='stylesheet' type='text/css' href='{{ url_for('static', filename='css/default.css') }}'><link rel='stylesheet' href='{{ url_for('static', filename='css/style.css') }}'> <link rel='stylesheet' type='text/css' href='{{ url_for('static', filename='css/reportAdd.css') }}'><link rel='stylesheet' type='text/css' href='{{ url_for('static', filename='css/common_ajax.css') }}'><link rel='stylesheet' type='text/css' href='{{ url_for('static', filename='css/font-awesome/font-awesome.min.css') }}'></head><body>"+report.html()+"</body></html>";
		
		
		$("#spin").css("display","block");
		$("#spin").css("height",$("#wrapper").height());
		
		$.ajax({
			url:"/workbench/user_bi/report/generate",
			type:"POST",
			timeout:30000,
			data:{
				report_name:title,
				html:html_layout
			},
			error: function(){
				$("#msg-content").html("连接服务器失败，请联系管理员");
				$("#msg-box").animate({top:"0"});
			},
			success: function(data){
				var dataJson = JSON.parse(data);
				if(dataJson.error_code==0){
					layer.open({
						title:'报表地址',
						content: dataJson.report_url,
						area: ['430px', '200px'],
						scrollbar: false,
						closeBtn: 0,
						btn: ['提交任务', '关闭', '复制去分享','去访问'],
						yes: function(index, layero){
							loadUnNeed(dataJson.report_url);
							var buttonName = "提交任务";
							addition = "报表生成完成";
							logupLoad(buttonName,addition);
						},cancel: function(index){
							var buttonName = "关闭";
							addition = "报表生成完成";
							logupLoad(buttonName,addition);
						},
						btn3: function(index,layero){
							var buttonName = "复制去分享";
							addition = "报表生成完成";
							logupLoad(buttonName,addition);
						},btn4: function(index,layero){
							var buttonName = "去访问";
							addition = "报表生成完成";
							logupLoad(buttonName,addition);
							window.open(dataJson.report_url);
						}
					});
					
					$(".layui-layer-btn2").zclip({ 
						path: '/static/js/jquery-zclip/ZeroClipboard.swf', 
						copy: function(){//复制内容 
							return dataJson.report_url; 
						}, 
						afterCopy: function(){//复制成功 
							$('.success-heading').html("复制成功！！");
							$('#success-box').animate({top:'0'});
							setTimeout("$('#success-box').animate({top:'-50%'})",3000);
						}
					});
					
					
					$('.success-heading').html("生成表报成功！！");
					$('#success-box').animate({top:'0'});
					setTimeout("$('#success-box').animate({top:'-50%'})",3000);
				}else{
					$("#msg-content").html(dataJson.error_messge);
					$("#msg-box").animate({top:"0"});
				}
			}
		});	
		setTimeout('$("#spin").css("display","none")',0);
	});
	
	
	//预览
	$(".preview").on("click",function(){
		$("#menu").animate({left:"-240px"},"slow");
		$("#main").animate({"padding-left":"0"},"normal");
		$(".preview").animate({opacity:"0"},"slow");
		$(".preview").css("display","none");
		$(".dis-preview").css("display","block");
		$(".dis-preview").animate({opacity:"1"},"slow");
	});
	
	//取消预览
	$(".dis-preview").on("click",function(){
		$("#menu").animate({left:"240px"},"normal");
		$("#main").animate({"padding-left":"240px"},"normal");
		$(".dis-preview").animate({opacity:"0"},"slow");
		$(".dis-preview").css("display","none");
		$(".preview").css("display","block");
		$(".preview").animate({opacity:"1"},"slow");
		
	});

	//请求未完成任务
	function loadUnNeed(targetUrl){
		
		//test
		/*var testJson = '{"data_list": [["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"],["uuid","name","deadline","description"]]}';
		var data1 = JSON.parse(testJson).data_list;
		loadUI(data1,targetUrl);*/
		//end test
		
		$("#spin").css("display","block");
		$("#spin").css("height",$("#wrapper").height());

		$.ajax({
			url:"/workbench/user_bi/needs/unfinished/list",
			type:"GET",
			timeout:30000,
			error: function(){
				$("#msg-content").html("连接服务器失败，请联系管理员");
				$("#msg-box").animate({top:"0"});
			},
			success: function(data){
				var dataJson = JSON.parse(data);
				if(dataJson.error_code==0){
					loadUI(dataJson.data_list,targetUrl);
					
					//$('.success-heading').html("生成表报成功！！");
					//$('#success-box').animate({top:'0'});
					//setTimeout("$('#success-box').animate({top:'-50%'})",3000);
				}else{
					$("#msg-content").html(dataJson.error_messge);
					$("#msg-box").animate({top:"0"});
				}
			}
		});	
		setTimeout('$("#spin").css("display","none")',0);
	}
	
	//渲染列表
	function loadUI(data,targetUrl){
		
		var target = $("#task-table");
			target.find(".data-tbody").html("");
			
			data.forEach(function(ele,idx){

				var tpl = $('<tr class=" gradeA"></tr>');
				var td_tpl = "";
				td_tpl += '<td class="task-cz"><input type="checkbox" data-uuid="'+ele[0]+'" class="task-check" name="check"/></td>';
				td_tpl += '<td class="task-name" data-uuid="'+ele[0]+'">'+ele[1]+'</td>';
				td_tpl += '<td class="task-deadline">'+ele[2]+'</td>';
				td_tpl += '<td class="task-description">'+ele[3]+'</td>';
			
				tpl.append(td_tpl);
				
				if(idx%2==0){
					tpl.addClass("odd");
				}else{
					tpl.addClass("even");
				}
				
				target.find(".data-tbody").append(tpl);
				
			});
			
			layer.open({
				title:'批量确认任务',
				content: target.html(),
				area: '1040px',
				scrollbar: false,
				btn: ['确认', '关闭'],
				closeBtn: 0,
				yes: function(index, layero){
					var buttonName = "批量确认任务";
					addition = "报表提交";
					logupLoad(buttonName,addition);
					target.find(".data-tbody").html("");
					$(".task-check").each(function(index, element) {
                        if($(this).prop("checked")==true){
							var uuid = $(this).attr("data-uuid"); 
							submitNeed(uuid,targetUrl);
						}
                    });
				},cancel: function(index){
					var buttonName = "关闭";
					addition = "报表提交";
					logupLoad(buttonName,addition);
				}
			});
	}
	
	
	//提交任务
	function submitNeed(uuid,result){

			$("#spin").css("display","block");
			$("#spin").css("height",$("body").height());
			$.ajax({
				url:"/workbench/user_bi/needs/submit",
				type:"POST",
				timeout:30000,
				data:{
					uuid:uuid,
					result:result
				},
				error: function(){
					$("#msg-content").html("连接服务器失败，请联系管理员");
					$("#msg-box").animate({top:"0"});
				},
				success: function(data){
					var dataJson = JSON.parse(data);
					if(dataJson.error_code==0){
						$('.success-heading').html("提交需求结果成功！！");
						$('#success-box').animate({top:'0'});
						setTimeout("$('#success-box').animate({top:'-50%'})",3000);
					}else{
						$("#msg-content").html(dataJson.error_messge);
						$("#msg-box").animate({top:"0"});
					}
				}
			});	
			setTimeout('$("#spin").css("display","none")',1000);
	}
	
})()